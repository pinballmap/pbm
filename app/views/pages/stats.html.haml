#page_body
  .column_container.stats_container
    .column.w_560.bg_vlightpurple
      %p.red.bold.p1 Pinball Map Stats
      %p Started mapping in 2008. Added "user accounts" in 2016, and since 2018/19 improved the stats we tracked.
      %p
        Currently listing
        %span{:class => 'red font18 bold'}
          #{number_with_delimiter(@locations_count_total,:delimiter => ",")}
        locations and
        %span{:class => 'red font18 bold'}
          #{number_with_delimiter(@machines_count_total,:delimiter => ",")}
        machines.
      %p
        #{number_with_delimiter(@users_count_total,:delimiter => ",")} registered user accounts (since 2017).
      %p
        #{number_with_delimiter(@user_submissions_total,:delimiter => ",")} maps edits (since 2015-ish).
      %p
        #{number_with_delimiter(@user_submissions_week,:delimiter => ",")} map edits in the last week.
    .column{:style => "width: 100%;"}
      %div
        - unless @machine_adds_this_year.blank?
          %p.bold.center Pinball machines made in #{@this_year}, added to locations
          = bar_chart @machine_adds_this_year.group('machine.name').count, height: "700px"
      %div.mt_20
        %p.bold.center Pinball machines made in #{@last_year}, added to locations up to now
        = bar_chart @machine_adds_last_year.group('machine.name').count, height: "700px"
      %div.mt_20.mb_20
        %p.bold.center Annual map edits from 2018 to today
        =area_chart @user_submissions_all.group_by_year(:created_at).count, xmin: "2018-01-01", thousands: ",", height: "400px"
    .column.w_560.bg_vlightpurple
      %p.font20.center.bold.pbt_5.bg_lightpurple
        Top 25 machines
      - @top_25.each do |row|
        %div{:style => 'display: flex; flex-direction: row; justify-content: space-between; padding: 0 10px;'}
          %p== #{link_to "#{row['machine_name']} (#{row['manufacturer']}, #{row['year']})", "/map?by_machine_id=#{row['id']}"}
          %p.bold.stat_values #{number_with_delimiter(row['machine_count'],:delimiter => ",")}
      %p.font20.center.bold.pbt_5.bg_lightpurple
        25 biggest locations
      - @top_locations.each do |row|
        %div{:style => 'display: flex; flex-direction: row; justify-content: space-between; padding: 0 10px;'}
          %p== #{link_to "#{row['name']}", "/map?by_location_id=#{row['id']}"}
          %p.bold.stat_values #{number_with_delimiter(row['machine_count'],:delimiter => ",")}
      %p.font20.center.bold.pbt_5.bg_lightpurple
        Top 10 cities by number of locations
      - @top_cities.each do |row|
        %div{:style => 'display: flex; flex-direction: row; justify-content: space-between; padding: 0 10px;'}
          - if row['state'].present?
            %p== #{link_to "#{row['city']}, #{row['state']}", "/map?by_city_name=#{row['city']}&by_state_name=#{row['state']}"}
          - else
            %p== #{link_to "#{row['city']}", "/map?by_city_no_state=#{row['city']}"}
          %p.bold.stat_values #{number_with_delimiter(row.location_count,:delimiter => ",")}
      %p.font20.center.bold.pbt_5.bg_lightpurple
        Top 10 cities by number of machines
      - @top_cities_by_machine.each do |row|
        %div{:style => 'display: flex; flex-direction: row; justify-content: space-between; padding: 0 10px;'}
          - if row['state'].present?
            %p== #{link_to "#{row['city']}, #{row['state']}", "/map?by_city_name=#{row['city']}&by_state_name=#{row['state']}"}
          - else
            %p== #{link_to "#{row['city']}", "/map?by_city_no_state=#{row['city']}"}
          %p.bold.stat_values #{number_with_delimiter(row.machines_count,:delimiter => ",")}
      %p.font20.center.bold.pbt_5.bg_lightpurple
        Top 25 users (# of edits)
      - @top_users.each do |row|
        %div{:style => 'display: flex; flex-direction: row; justify-content: space-between; padding: 0 10px; align-items: flex-end;'}
          %p== #{link_to "#{row.username}", "users/#{row['id']}/profile"}
          %p.bold.stat_values #{number_with_delimiter(row.user_submissions_count,:delimiter => ",")}


